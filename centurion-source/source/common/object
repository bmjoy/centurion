#pragma once

#include <gui>
#include <json.hpp>

using namespace std;
using namespace glm;

namespace unit { class Unit; };
namespace building { class Building; };

class Player;

//
//	GAME OBJECT --> source/object.cpp
//

class GObject {
public:
	GObject();
	void set_position(vec3 pos);
	void set_class(string class_name);
	void set_player(Player *p);
	void set_id(int pickingId);
	bool getSelected() { return selected; }
	int get_xPos() { return (int)position.x; }
	int get_yPos() { return (int)position.y; }
	~GObject();
protected:
	Player *player;
	vec3 pickingColor;
	bool selected;
	json data;
	vec3 position;
	string className;
	int picking_id;
};

//
//	BUILDING --> source/building/building.cpp
//

namespace building {
	class Building : public GObject
	{
	public:
		Building();
		void create();
		void render(bool picking, int clickID);
		int UnitsInBuilding();
		vector<unit::Unit> UnitsInHolder();
		~Building();

	private:
		vector<vector<int>> building_grid;
		vector<unit::Unit> unitsInside;
		int w, h, nrChannels;
		GLuint textureID;
		bool clickableInMinimap;
		//sound selectionSound; TODO
	};
};

//
//	UNIT  
//

namespace unit {

	// UNIT CLASS  --> source/unit/unit.cpp

	class Unit : public GObject
	{
	public:
		Unit();
		void create();
		void set_position(float x, float y);
		void render(mat4 &proj, mat4 &view, bool picking, int clickID);
		~Unit();
	private:
		UnitData unitData;

		/* unit properties & data */
		string currentStateStr;
		json entityData;
		float creationTime;

		/* unit position */
		vec3 position2D, position3D;
		bool clickSelection, rectangleSelection;

		/* unit circle if selected */
		gui::Circle selectionCircle;

		/* unit movement & pathfinding */
		bool is_Moving;
		int pathCount;
		float angle, delta, distance, res_distance;
		vector<ivec2> path;
		vec2 startPoint, endPoint;
		void position_update();
		void walk_behaviour();

		/* debug objects */
		vector<gui::Rectangle> pathQuadsList;
		struct HitBox {
			gui::Rectangle rectangle;
			array<float, 8> coords;
		} hitbox;
		gui::Image circlePos;
	};


	// UNIT FUNCTIONS --> source/unit/functions.cpp

	void updateZ(vec3 &pos2d, vec3 *pos3d);
	void updateFrame(float *creationTime, int *frame, int max_frames, int duration);
	bool isInSelectionRect(array<float, 8> &coords);
	float getAngle(vector<ivec2> &path, int &n);
	float getDistance(vector<ivec2> &path, int &n);
	float getResDistance(vector<ivec2> &path, int &n, vec3 &pos2d);
	vector<ivec2> getPath(vec2 &start, vec2 &end);
};